#!/bin/bash

set -e

DEPLOYMENT="messaging-app-blue"
SERVICE_URL="http://localhost:8000"

echo "üöÄ Applying updated deployment (Rolling Update)..."
kubectl apply -f blue_deployment.yaml

echo "üîÑ Monitoring rollout status..."
kubectl rollout status deployment/$DEPLOYMENT

echo "üß† Verifying running pods after update..."
kubectl get pods -l app=messaging-app -l version=blue

echo "üåê Starting curl test to check for downtime..."
echo "Press Ctrl+C to stop monitoring."

while true; do
  if curl -s --max-time 2 $SERVICE_URL > /dev/null; then
    echo "‚úÖ App is responding (no downtime detected)"
  else
    echo "‚ùå App not responding (possible downtime)"
  fi
  sleep 2
done
